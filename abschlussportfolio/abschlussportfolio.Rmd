---
author: "Flo Wisniewski"
date: "`r format(Sys.Date())`"
title: "Übung: Advanced R --- Abschlussportfolio"
subtitle: "Sommersemester 2021 | Leitung: J. Goes"
output:
  rmdformats::material:
    highlight: espresso
  toc: true
  number_sections: true
abstract:
  "In diesem Portfolio sollen verschiedene sozialwissenschaftliche Datensätze hinsichtlich zentraler Werte statistisch aufgearbeitet und anschließend visualisiert werden."
lang: "DE"
runtime: shiny
documentclass: "article"
geometry: "2.5"
fontfamily: "Roboto"
fontsize: "11pt"
linkcolor: "green"
citecolor: "blue"
urlcolor: "blue"
bibliography: literature.bib
---

```{r setup, include=FALSE}
library(knitr)
library(rmdformats)

## Global options
options(max.print="75")
opts_chunk$set(echo=TRUE,
	             cache=TRUE,
               prompt=FALSE,
               tidy=TRUE,
               comment=NA,
               message=FALSE,
               warning=FALSE)
opts_knit$set(width=75)
```

# Einleitung

```{r load dfs, echo = FALSE, message=FALSE, warning=FALSE, include=FALSE, paged.print=FALSE}
setwd(dir = "/Users/flo/Documents/Uni/Uni Bamberg/SS 2021/Advanced R/advanced-r")

allbus <- read_dta(file = "ALLBUS2018/allbus2018.dta")
gles <- read_dta(file = "GLES2017/GLES2017")
```

> The simple graph has brought more information to the data analyst's mind than any other device.^[@RDataScience, S. 3]

Dieses Zitat des bekannten Statistikers und (Mit-)Erfinders des Boxplots John Tukey lässt sich zu Beginn des ersten Kapitels des Einführungswerks *"R for Data Science"* von Hadley Wickham und Garrett Grolemund finden.

Der Einschätzung Tukeys ist zweifelsohne beizupflichten: Es sind aktuell wohl nur wenige statistische Untersuchungen bekannt, die nicht auf irgendeine denkbare Art und Weise eine Form graphischer Darstellung zur Erklärung der Befunde nutzen würden.
Dass das Analysetool "graphische Darstellung" derartig oft genutzt wird und eine so große Wertschätzung genießt, liegt dabei eigentlich auf der Hand; der bekannte Ausspruch, dass ein Bild mehr sage, als 1.000 Worte gilt wohl auch in der statistischen Analyse: eine gut erstellte und übersichtliche Graphik vermag es wirklich, Befunde kurz und knapp und vor allen Dingen **allgemein verständlich** auf den Punkt zu bringen. Für einen Blick in beispielsweise eine Regressionstabelle eines Mehrebenenmodells jedoch, so darf angezweifelt werden, kann dies nicht unbedingt in jedem Fall behauptet werden.

Um jedoch dem Anspruch an die Übersetzung von Informationen in großer Masse in Graphiken gerecht zu werden, brauchen die Analysierenden zweckmäßige und mächtige Tools. Die Programmiersprache `R` offenbart im Umgang mit großen Datenmengen gegenüber Konkurrenten wie `SPSS` von IBM oder auch `Stata` entscheidende Vorteile. Zwar können in den anderen Statistiksoftware-Angeboten ebenfalls Graphiken erstellt werden (sowohl durch das Klicken in Menüs, als auch syntaxbasiert) - jedoch kann wohl mit Recht behauptet werden, dass die Möglichkeiten der Visualisierung von Daten in `R` wesentlich umfassender sind, was vor allem auch an einem Package liegt: `ggplot2`.

Dieses ist im bekannten und beliebten `tidyverse` enthalten, einem Meta-Package, welches von Hadley Wickham und seinem Team für die Nutzung durch Data Scientists entwickelt wurde und essentielle und nützliche Packages zur einfachen Installation sammelt. Das Package `ggplot2` selbst wird darüber hinaus, ebenso wie viele weitere aus dem `tidyverse` immer wieder in Listen über die einfluss- und hilfreichsten Packages in R genannt (siehe z. B. Finnstats ^[@finnstats])

Im folgenden Dokument soll sich nun exemplarisch mit Daten aus der Sozialwissenschaft auseinandergesetzt werden. Dafür werden die Datensätze des **ALLBUS** (*Allgemeine Bevölkerungsumfrage der Sozialwissenschaften*, von 2018)^[@ALLBUS2018] und der **GLES** (*German Longitudinal Election Study* in der Version der Nachwahlbefragung, von 2017)^[@GLES2017] genutzt.

Es sollen mit Hilfe dieser Daten verschiedene interessante Sachverhalte und Zusammenhänge visuell aufbereitet und analysiert werden - all das unter der Nutzung des R-Packages `ggplot2`. Im Fokus wird die eigentliche Arbeit mit dem Package selbst stehen. Dessen Möglichkeiten sollen, im Rahmen der kurzen Analysen und Visualisierungen, möglichst voll ausgeschöpft werden, sodass dessen Vorzüge (nicht nur gegenüber anderen Softwarelösungen, sondern auch gegenüber z. B. den Plots aus `baseR`) für den Nutzenden klar zum Vorschein kommen.

## Zur Erstellung genutzte Libraries

Zuerst zu den im vorliegenden Dokument genutzten R-Libraries. Zum Überblick dient nachfolgende Liste:

```{r}
# libraries
library(tidyverse)
library(plotly)
library(ymlthis)
library(haven)
library(foreign)
library(esquisse)
library(expss)
library(MASS)
```

Zur Erstellung der Graphiken in diesem Portfolio wird auf `ggplot2` aus dem `tidyverse` zurückgegriffen, da dieses umfassende Möglichkeiten hierzu bietet. Es können damit vielseitige Graphiken erstellt werden, die mehrere Layer haben. Ebenso wird das Package `plotly` verwendet, um teilweise `ggplot2`-Graphiken für die Betrachtenden des abschließenden HTML-Dokuments interaktiv zu gestalten.

# Inhaltlich zu `ggplot2`

> Unlike most other graphics packages, ggplot2 has an underlying grammar, based on the Grammar of Graphics, that allows you to compose graphs by combining independent components. [...] Rather than being limited to sets of pre-defined graphics, you can create novel graphics that are tailored to your specific problem^[@wickham_navarro_pedersen2009, Section 1.1]. 

Zuerst werden inhaltliche Dinge zu `ggplot2` geklärt, wie zum Beispiel die Entstehung und die zugrundeliegende Philosophie. Weiterhin wird kurz auf die Funktionsweise bzw. -prinzipien eingegangen. Anschließend soll in aller Kürze das Package `esquisse` vorgestellt werden, welches für Lernende genauso wie erfahrene Nutzende im Bezug auf `ggplot2` von großem Vorteil sein kann.

## Inhaltlich 1: Entstehung von `ggplot2`, Teil des `tidyverse`, Wirkung in der R-Community, Grundideen und -prinzipien

Zwischen den Nutzern von `baseR` und `ggplot2` gibt es eine (mal mehr, mal weniger) hitzig geführte Debatte darüber, welches der Pakete zur Visualisierung von Daten besser geeignet sei. Die sehr kurze Konsultation einer Internet-Suchmaschine mit dem Suchstring *ggplot2 vs. baseR* ergab zahlreiche Treffer - besonders oft Blogeinträge von Nutzenden, die für eine "Seite" Partei ergreifen. Es wird betont, dass der Code zur Erstellung von Graphiken in `ggplot2` wesentlich konziser ist, als in `baseR`^[@statsinthewild], oder auch, dass der Code darüber hinaus in `ggplot2` außerdem weniger abstrahiert sein müsste (es werden z. B. die Arbeit mit subsets von Daten oder auch das "faceting", also die Erstellung von gruppierten Graphiken, angesprochen)^[@varianceexplained].

Um jedoch die Funktionsweise und das Konzept von `ggplot2` genau nachvollziehen zu können, ist es sinnvoll, sich in Erinnerung zu rufen, woher die Ideen für das Package stammen. Hadley Wickham griff bei der Entwicklung bezüglich der Grundideen auf die *Grammar of Graphics* von 2005^[@wilkinson2005] zurück - ein von Leland Wilkinson entwickeltes Konzept bzw. eine Art Leitfaden zur Visualisierung von Ergebnissen in der Statistik.

Wickham selbst legte die Kernpunkte gut in einem Artikel aus dem Jahr 2010 ^[@layered-grammar, S. 3f.]: Zunächst steht die Feststellung im Zentrum, dass es für die Visualisierung mittels Graphiken eine Grammatik geben muss, die eine Grundstruktur gibt. Es geht darum, Graphiken nicht als monolithische Einheiten anzusehen, sondern die verschiedenen Schichten darin zu erkennen. Das wiederum ermögliche, so Wickham, diese einzelnen Schichten auch zu adressieren. Bereits im Abstract von Wickhams Artikel wird somit deutlich angesprochen: durch die "Grammar of Graphics" ist es möglich, nicht mehr nur von verschiedenen *Graphikarten*, wie z. B. dem Scatterplot, zu sprechen - es wird vielmehr möglich über **jede einzelne Ebene** der Graphiken etwas auszusagen und damit eine tiefergehende Struktur dieser anzusprechen.

In einem Focus Article von 2011 spricht auch Wickham dann die unterschiedlichen Herangehensweisen des Erstellens von Graphiken und Plots an. Wenn Nutzende auf `baseR` oder auch `lattice` zurückgriffen, dann wären sie genau an dem zuvor beschriebenen Punkt: sie müssten sich die Frage stellen, welche Art von Graphik am besten die vorliegenden Daten beschreiben könne (also, ob bspw. ein Scatterplot gewählt wird oder ein Boxplot, usw.). Die Nutzenden könnten das bestimmen - und müssten dann mit den gegebenen Parametern arbeiten:

> To create a plot, you figure out the closest named graphic and then tweak plot parameters and add primitives to bring your idea to life. For complicated graphics, code is usually imperative: draw a line here, draw text there, do this, do that, and you have to worry about many low-level details^[@ggplot2-wires, S. 2].

Dem gegenüber setzt Wickham nun die Arbeit mittels `ggplot2`, welche grundsätzlich anders funktioniert, eben weil die Grammar of Graphics hier implementiert wurde:

> You think about how your data will be represented visually, then describe that representation using a declarative language. The declarative language, or grammar, provides a set of independent building blocks, similar to nouns and verbs, that allow you to build up a plot piece by piece. You focus on describing what you want, leaving it up to the software to draw the plot^[@ggplot2-wires, S. 2].

## Inhaltlich 2: Funktionsweise von `ggplot2`: Einbinden verschiedener Layer und Nutzung des Pipe-Operators

Die Funktionsweise wird dann nochmals genauer spezifiziert. Wickham beschreibt, was genau er mit den einzelnen Schichten meint. So könnte man beispielsweise bei einem einfachen Scatterplot drei unterschiedlicher "Layer" ausmachen: einerseits die Punkte und deren Größe bzw. Form als die geometrischen Objekte. Weiterhin die Skalen, dazu noch das Koordinatensystem, welches sozusagen den Rahmen darstellt. Fügt man diese "Bauteile" zusammen, so erhält man die grundlegende Graphik ^[@layered-grammar, S. 6].

Diese Philosophie verfolgt nun auch, wie bereits zuvor beschrieben wurde, `ggplot2` in der aktiven Umsetzung innerhalb von R.
Jede `ggplot2`-Graphik besteht im Grunde aus diesen Komponenten:

  1. **Daten**, die für den Plot verwendet werden sollen. Diese werden mittels des Parameters `data` spezifiziert.
  2. **Aesthetic mappings**: Hier wird mittels `aes()`spezifiziert, welche Variablen geplotted werden, wie diese arrangiert werden sollen, welche Formen angenommen werden sollen, welche Farben zu welchen Variablen zugewiesen werden, usw. Die Möglichkeiten sind extrem vielfältig.
  3. **Geoms**: Die Art und Weise, auf welche die in 1. und 2. gegebenen Informationen graphisch umgesetzt bzw. visualisiert werden sollen. Geoms verschiedenster Formen können wiederum geschichtet werden, um verschiedene Layer übereinander zu legen.

Bei diesen drei Schritten ist zu beachten: Begonnen wird eine Graphik, indem `ggplot()` in der IDE nach Wahl geschrieben wird. welche Daten und ästhetischen Mappings verwendet werden ist sowohl einerseits *global* (innerhalb der Klammern von `ggplot()`) als auch lokal (innerhalb der einzelnen geoms) möglich. Dies steigert wiederum erneut die Möglichkeiten der Schichtung verschiedener Visualisierungsoptionen. Intuitiv wird die Verwendung des Packages auch dadurch, dass die einzelnen Layer einfach mittels eines `+`-Zeichens sozusagen "aufaddiert" werden. Während also in Plots in `baseR` teilweise mit `for`-loops oder dergleichen gearbeitet werden muss, um verschiedene Ebenen zu erzeugen, reicht ein einfaches `+` in `ggplot2` schon aus.

Einige Beispiele für die Funktionsweise von `ggplot2` "in Aktion" lassen sich im Analyseteil dieses Dokumentes finden.

## Inhaltlich 3: Weitere Vereinfachung der Nutzung von `ggplot2` durch Nutzung von `esquisse`

Den Nutzenden, die eventuell jedoch einen Wechsel von `baseR` hin zu `ggplot2` planen, erscheint diese Art der Syntax eventuell noch ein wenig fremd. Ebenso könnte es sich für gänzlich neue R-NutzerInnen ergeben, dass ein mehrzeiliges `ggplot()`-Statement auf den ersten Blick etwas verwirrend aussieht.

Um Nutzenden dennoch eine Möglichkeit zu geben, intuitiv und so schnell wie möglich einen visuellen Überblick über spezielle Daten zu erhalten, wurde das Package `esquisse` von Fanny Meyer, Victor Perrier und deren Team entwickelt, welches für die Nutzenden ein shiny-Addin für RStudio installiert, mit dem das Generieren und direkte Betrachten von Graphiken im Format von `ggplot2` ermöglicht wird. Ebenso wird der erforderliche Code für erstellte Graphiken angezeigt, sodass dieser einfach kopiert und übernommen werden kann, sollte sich eine Graphik für eine bestimmte Form von Report o. Ä. als relevant erweisen^[@esquisse_webpage].

# Analyseteil: Praktische Nutzung von `ggplot2`

## Analyse 1: Thema "Herkunft und Parteienpräferenz" in ALLBUS und GLES

Um nun die Vorzüge und Möglichkeiten von `ggplot2` nicht nur zu beschrieben, sondern auch praktisch umzusetzen, sollen nun, wie in der Einleitung angekündigt, einige exemplarische Analysen durchgeführt werden. Zunächst wird anhand der ALLBUS-Daten ein kurzer Überblick über den Zusammenhang von Herkunft innerhalb Deutschlands ("Alte" vs. "Neue" Bundesländer) und der Parteipräferenz von Wählern gegeben.

So könnte man sich beispielsweise dafür interessieren, wo die genauen Unterschiede zwischen diesen Wählerpopulationen liegen. Es herrschen die gängigen Annahmen vor, dass die AfD als Partei im Osten Deutschlands mehr Stimmen generieren kann, als im Westen des Landes. Außerdem wurden, unter anderem im Zuge der Wahlen in Sachsen-Anhalt, die Probleme der Grünen im Osten angesprochen, welche dazu führen, dass die Partei dort eher weniger stark Fuß fassen kann.

Diese Unterschiede könnte man natürlich auch mittels eines Blicks auf "nackte Zahlen" einer (relativen) Häufigkeitsverteilung untersuchen - doch ist ein solcher *übersichtlicher*, *einfacher* und *klarer*, wenn man sich der graphischen Darstellung mittels `ggplot2` bedient.

```{r herkunft und parteipräferenz, message=FALSE, warning=FALSE, paged.print=FALSE}
# zum plotten als typ factor umformen
allbus$sonntagsfrage <- factor(allbus$pv01, labels = c("Nicht wahlberechtigt", "K. Ang.", "Weiß nicht",
                                                       "Verweigert", "Union", "SPD", "FDP", "Grüne",
                                                       "Linke", "AfD", "Andere", "Nichtwähler"))

allbus$ostwest <- factor(allbus$eastwest, labels = c("West", "Ost"))

# erstellen der graphik
herkunft <- ggplot(allbus) +
  geom_bar(aes(x = ostwest, fill = sonntagsfrage, weight = wghtpew), position = "fill") +
  theme_classic() +
  scale_fill_manual(values = c("#f6b109", "#00fff9", "#fa98fb", "#ccabab", "#000000", "#ff0000", "#fdff00", "#338140", "#803381", "#0979f6", "#3e2a0c", "#5c5c5c")) +
  ggtitle(label = "Wahlabsichten in den 'alten' \n vs. in den 'neuen' Bundesländern") +
  xlab(label = "") +
  ylab(label = "Proportionale Verteilung") +
  guides(fill = guide_legend(title = "Wahlabsicht Befragte/r"))
```

```{r ggplotly interactive, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
# für den report: graphik kann auch interaktiv gestaltet werden über plotly, was nur einen einzigen befehl benötigt
ggplotly(herkunft)
```

Die Graphik wurde mittels `plotly` interaktiv gestaltet, sodass bei Betrachtung im HTML-Output Informationen (z. B. die Gruppe, also Ost/West; die Gewichtung; den Anteil der Partei an der prozentualen Verteilung) angezeigt werden, sobald der Mauszeiger über eine farblich abgehobenen Kategorie geführt wird. Ebenso können per Doppelklick auf eine Kategorie der Legende alle anderen Kategorien ausgeblendet werden, was einen Vergleich zwischen "Ost" und "West" extrem einfach macht.

Zur Graphik selbst ist zu sagen, dass mittels des Parameters `position = "fill"` für das gewählte `geom_bar` eine Anpassung an die volle Höhe des Koordinatensystems vorgenommen wurde. Diese "Standardisierung" der Werte führt zu einer bestmöglichen Vergleichbarkeit zwischen den Gruppen.

Es kann aus der Graphik somit einfach herausgelesen werden, dass die Wählerschaften der Linken und der AfD (Stand 2018) im Osten Deutschlands wesentlich größer sind, als im Westen. Darüber hinaus bestätigt sich das Bild, dass es die Grünen im Osten des Landes schwer haben, vergleicht man die beiden Gruppen in Ost und West. Es fällt für das Jahr 2018 ebenso auf, dass die Gruppe der Nichtwähler im Osten des Landes unübersehbar größer ist, als im Westen. Alle diese Ergebnisse wurden zudem über den `weight`-Parameter und eine dafür vorgesehene Variable des ALLBUS gewichtet, da die Befragten aus dem Osten Deutschlands im ALLBUS im Verhältnis zum wahren Bevölkerungsanteil überrepräsentiert sind.

## Analyse 2: Thema "Herkunft und Fremdenfeindlichkeit" im ALLBUS



## Analyse 3: Logistische Regression zu Fremdenfeindlichkeit - welche Einflüsse gibt es?

Weiterhin lassen sich mittels `ggplot2` auch wertvolle graphische Analysen von Regressionsmodellen durchführen. Als Beispiel soll hier ein kleines logistisches Regressionsmodell gerechnet werden. Für dieses werden dann die odds ratios berechnet, welche zur Interpretation auf reiner Zahlenbasis zumindest etwas dienlicher sind, als die log odds.

Dann soll ein Vergleich mit der Interpretation durch Visualisierung durchgeführt werden, um zu zeigen, wie hilfreich dies sein kann, wenn man statistische Ergebnisse nicht nur errechnen, sondern z. B. auch präsentieren muss. Hier kann nicht immer vorausgesetzt werden, dass die Teilnehmenden einer Konferenz oder eines Meetings die von einem selbst gerechneten Modelle mit dem ersten Blick auf große Tabellen sofort verstehen. Intuitiver ist da jedoch der Blick auf Graphiken.

```{r}
fre(allbus$sonntagsfrage)

allbus$dummy_wahlabs <- ifelse(allbus$sonntagsfrage == "Grüne", 1, 0)
fre(allbus$dummy_wahlabs)

# erstes beispielmodell: klassifikation vom wahlabsichts-dummy
model1 <- glm(data = allbus, formula = dummy_wahlabs ~ age + ostwest + inc + as.factor(id03), family = "binomial"(link = "logit"))
summary(model1)
exp(cbind(coef(model1), confint(model1)))
```


## Analyse 4: Warum `ggplot2` und nicht einfach `baseR`?



## Analyse 5: Evtl. noch was zu sozialer Klasse



# Schlussbemerkungen/Fazit

Für das vorliegende Portfolio findet sich [unter diesem Link]() ein zugehöriges GitHub-Repository, welches zum Überblick und zur Versionskontrolle genutzt wurde.

+ ggplot bietet quality of life verbesserungen ggü. baseR
+ ggplot ist unglaublich customizable
+ ggplot bietet vielerlei ressourcen, um sich mit der funktionsweise vertraut zu machen
  + diese ressourcen == meist kostenlos online verfügbar
+ super integration von ggplot2 plots in rmarkdown, welches in sich wiederum eine enorme erleichterung für "data driven reports" ist


# Literatur {-}
